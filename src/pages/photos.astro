---
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import { getAllCountries } from "@data/photos";
import { EXCLUDED_PHOTO_SET } from "@data/photosConfig";

const countries = getAllCountries();
const visibleCountries = countries.filter(country => !EXCLUDED_PHOTO_SET.has(country.slug));
const preferredOrder = ["nepal", "mexico", "senegal", "india", "tanzania", "guatemala"];
const orderedCountries = [
  ...preferredOrder
    .map(slug => visibleCountries.find(country => country.slug === slug))
    .filter(Boolean),
  ...visibleCountries.filter(country => !preferredOrder.includes(country.slug)),
];

const STABLE_SEED = import.meta.env.PUBLIC_PHOTO_SEED ?? "default-seed";
const getDeterministicIndex = (slug: string, length: number) => {
  const seed = `${STABLE_SEED}-${slug}`;
  let hash = 0;
  for (let i = 0; i < seed.length; i += 1) {
    hash = (hash << 5) - hash + seed.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash) % length;
};

// Get one deterministic photo per country for the cover
const photoCollections = orderedCountries
  .filter((country): country is NonNullable<typeof country> => country !== null && country !== undefined)
  .map(country => {
    const randomIndex = getDeterministicIndex(country.slug, country.photos.length);
    return {
      country: country.name,
      slug: country.slug,
      coverImage: country.photos[randomIndex].src
    };
  });
---

<PageLayout title="Photos" description="A collection of photos from my adventures">
  <Container>
    <div class="space-y-10">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {photoCollections.map((collection) => (
          <a
            href={`/photos/${collection.slug}`}
            class="group relative overflow-hidden aspect-square block"
          >
            <img
              src={collection.coverImage}
              alt={collection.country}
              class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
            />
            <div class="absolute inset-0 bg-black bg-opacity-40 group-hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center">
              <h2 class="font-display font-semibold text-2xl md:text-3xl lg:text-4xl text-white">
                {collection.country}
              </h2>
            </div>
          </a>
        ))}
      </div>
    </div>
  </Container>
</PageLayout>
